<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4chan Scraper</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --border-color: #30363d;
            --accent: #58a6ff;
            --greentext: #789922;
            --quote-bg: #1c2128;
            --hover-bg: #30363d;
            --sidebar-width: 280px;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-tertiary: #eaeef2;
            --text-primary: #24292f;
            --text-secondary: #57606a;
            --border-color: #d0d7de;
            --accent: #0969da;
            --greentext: #1a7f37;
            --quote-bg: #f6f8fa;
            --hover-bg: #eaeef2;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .sidebar-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .icon-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .icon-btn:hover {
            background: var(--hover-bg);
        }

        .history-section, .boards-section {
            padding: 15px;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .history-item, .board-item {
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .history-item:hover, .board-item:hover {
            border-color: var(--accent);
            background: var(--hover-bg);
        }

        .history-item .board-tag {
            color: var(--accent);
            font-weight: bold;
        }

        .history-item .thread-title {
            color: var(--text-primary);
            display: block;
            margin-top: 4px;
        }

        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .sidebar-toggle {
            position: fixed;
            left: 10px;
            top: 10px;
            z-index: 101;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-toggle:hover {
            background: var(--hover-bg);
        }

        header {
            background: var(--bg-secondary);
            padding: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .container.centered {
            max-width: 1000px;
        }

        h1 {
            color: var(--accent);
            margin-bottom: 10px;
        }

        .nav {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--hover-bg);
        }

        .boards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .board-card {
            background: var(--bg-secondary);
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .board-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .board-name {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent);
        }

        .threads-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .thread-item {
            background: var(--bg-secondary);
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            gap: 15px;
        }

        .thread-item:hover {
            border-color: var(--accent);
        }

        .thread-thumb {
            width: 150px;
            height: 150px;
            flex-shrink: 0;
            border-radius: 4px;
            overflow: hidden;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .thread-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thread-thumb .placeholder {
            color: var(--text-secondary);
            font-size: 48px;
        }

        .thread-details {
            flex: 1;
        }

        .thread-info {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .post {
            background: var(--bg-secondary);
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .post-content {
            color: var(--text-primary);
            word-wrap: break-word;
        }

        .greentext {
            color: var(--greentext);
        }

        .post-link {
            color: var(--accent);
            text-decoration: none;
            cursor: pointer;
        }

        .post-link:hover {
            text-decoration: underline;
        }

        .post-image {
            margin: 10px 0;
            max-width: 100%;
        }

        .post-image img {
            max-width: 250px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .post-image img:hover {
            opacity: 0.8;
        }

        .hover-preview {
            position: fixed;
            background: var(--bg-tertiary);
            border: 2px solid var(--accent);
            border-radius: 6px;
            padding: 10px;
            max-width: 400px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .image-preview {
            position: fixed;
            z-index: 1000;
            pointer-events: none;
            border: 2px solid var(--accent);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .image-preview img {
            max-width: 500px;
            max-height: 500px;
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent);
        }

        .close-btn {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        .settings-group {
            margin-bottom: 25px;
        }

        .settings-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .settings-input, .settings-select {
            width: 100%;
            padding: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .hidden {
            display: none;
        }

        .op-post {
            border-left: 3px solid var(--accent);
        }

        .quote-link {
            color: #d73a49;
            text-decoration: none;
            cursor: pointer;
            font-weight: bold;
        }

        .quote-link:hover {
            text-decoration: underline;
        }

        .error {
            background: #3a1919;
            color: #f85149;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #d73a49;
            margin-bottom: 20px;
        }
    </style>
</head>
<body data-theme="dark">
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title"><i class="fas fa-folder-open"></i> Browser</div>
            <div class="sidebar-actions">
                <button class="icon-btn" onclick="openSettings()" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="icon-btn" onclick="clearHistory()" title="Clear History">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>

        <div class="history-section">
            <div class="section-title"><i class="fas fa-history"></i> Recent Threads <input type="text" id="historySearch" placeholder="Search..." style="float:right; width:100px;" onkeyup="filterHistory()"></div>
            <div id="historyList"></div>
        </div>

        <div class="boards-section">
            <div class="section-title"><i class="fas fa-list"></i> Quick Boards</div>
            <div id="quickBoards"></div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <header>
            <div class="container">
                <h1><i class="fas fa-archive"></i> Local 4chan Scraper</h1>
                <p style="color: var(--text-secondary)">Browse 4chan boards locally with caching</p>
                <div class="nav">
                    <button class="btn hidden" id="backBtn" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn" onclick="refreshCache()">
                        <i class="fas fa-sync"></i> Refresh Cache
                    </button>
                </div>
            </div>
        </header>

        <div class="container centered" id="mainContainer">
            <div id="boardsView">
                <h2>Boards</h2>
                <div class="loading">Loading boards...</div>
                <div class="boards-grid" id="boardsList"></div>
            </div>

            <div id="threadsView" class="hidden">
                <h2 id="boardTitle"></h2>
                <div>
                    <input type="text" id="threadSearch" placeholder="Search threads..." class="settings-input" onkeyup="filterThreads()">
                </div>
                <div class="loading">Loading threads...</div>
                <div class="threads-list" id="threadsList"></div>
            </div>

            <div id="threadView" class="hidden">
                <h2 id="threadTitle"></h2>
                <div class="nav" id="threadNav">
                    <button class="btn" id="prevThreadBtn" style="display:none"><i class="fas fa-arrow-left"></i> Prev Thread</button>
                    <button class="btn" id="nextThreadBtn" style="display:none"><i class="fas fa-arrow-right"></i> Next Thread</button>
                </div>
                <div class="loading">Loading posts...</div>
                <div id="postsList"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal" onclick="if(event.target === this) closeSettings()">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <span class="close-btn" onclick="closeSettings()">&times;</span>
            </div>

            <div class="settings-group">
                <label class="settings-label">Theme</label>
                <select class="settings-select" id="themeSelect" onchange="changeTheme()">
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                    <option value="custom">Custom</option>
                </select>
                <div id="customColorsGroup" class="settings-group" style="display:none;">
                    <label>Custom Colors</label>
                    <div class="checkbox-group">
                        <label>Background Primary: <input type="color" id="colorBgPrimary" /></label>
                    </div>
                    <div class="checkbox-group">
                        <label>Text Primary: <input type="color" id="colorTextPrimary" /></label>
                    </div>
                    <!-- Add more color pickers as needed for other variables -->
                </div>
            </div>

            <div class="settings-group">
                <label class="settings-label">Layout</label>
                <select class="settings-select" id="layoutSelect" onchange="changeLayout()">
                    <option value="centered">Centered</option>
                    <option value="wide">Wide</option>
                </select>
            </div>

            <div class="settings-group">
                <label class="settings-label">Symbols</label>
                <select class="settings-select" id="symbolSelect" onchange="changeSymbols()">
                    <option value="unicode">Unicode</option>
                    <option value="fontawesome">Font Awesome</option>
                    <option value="nerdfonts">Nerd Fonts</option>
                </select>
            </div>

            <div class="settings-group">
                <label class="settings-label">Features</label>
                <div class="checkbox-group">
                    <input type="checkbox" id="showUsernames" checked onchange="saveSettings()">
                    <label for="showUsernames">Show Usernames</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="enableImageHover" checked onchange="saveSettings()">
                    <label for="enableImageHover">Enable Image Hover</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="enableReplyHover" checked onchange="saveSettings()">
                    <label for="enableReplyHover">Enable Reply Hover</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="enableTreeView" onchange="saveSettings()">
                    <label for="enableTreeView">Enable Tree View</label>
                </div>
            </div>

            <div class="settings-group">
                <label class="settings-label">Auto-refresh</label>
                <div class="checkbox-group">
                    <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                    <label for="autoRefresh">Enable Auto-refresh</label>
                </div>
                <input type="number" class="settings-input" id="refreshInterval" value="60" min="30" max="300" placeholder="Seconds">
            </div>

            <div class="settings-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="sidebarAutoHide" checked onchange="saveSettings()">
                    <label for="sidebarAutoHide">Sidebar Auto-hide</label>
                </div>
            </div>

            <button class="btn" onclick="saveSettings()">
                <i class="fas fa-save"></i> Save Settings
            </button>
        </div>
    </div>

    <script>
        let currentBoard = null;
        let currentThread = null;
        let postsData = {};
        let viewStack = [];
        let settings = {};
        let autoRefreshInterval = null;
        let sidebarTimeout = null;
        let threadPositions = JSON.parse(localStorage.getItem('threadPositions') || '{}');
        let currentCatalog = null;

        // Initialize
        loadSettings();
        loadBoards();
        loadHistory();
        setupSidebarAutoHide();

        function loadSettings() {
            fetch('/api/settings')
                .then(r => r.json())
                .then(data => {
                    settings = data;
                    applySettings();
                });
        }

        function applySettings() {
            document.body.setAttribute('data-theme', settings.theme || 'dark');
            document.getElementById('themeSelect').value = settings.theme || 'dark';
            document.getElementById('layoutSelect').value = settings.layout || 'centered';
            document.getElementById('symbolSelect').value = settings.useSymbols || 'fontawesome';
            document.getElementById('showUsernames').checked = settings.showUsernames !== false;
            document.getElementById('enableImageHover').checked = settings.enableImageHover !== false;
            document.getElementById('enableReplyHover').checked = settings.enableReplyHover !== false;
            document.getElementById('enableTreeView').checked = settings.enableTreeView === true;
            document.getElementById('autoRefresh').checked = settings.autoRefresh === true;
            document.getElementById('refreshInterval').value = settings.refreshInterval || 60;
            document.getElementById('sidebarAutoHide').checked = settings.sidebarAutoHide !== false;

            if (settings.theme === 'custom') {
                document.getElementById('customColorsGroup').style.display = 'block';
                Object.entries(settings.customColors || {}).forEach(([key, val]) => {
                    document.documentElement.style.setProperty(`--${key}`, val);
                });
                document.getElementById('colorBgPrimary').value = settings.customColors.bgPrimary || '#0d1117';
                document.getElementById('colorTextPrimary').value = settings.customColors.textPrimary || '#c9d1d9';
                // Add more
            } else {
                document.getElementById('customColorsGroup').style.display = 'none';
            }

            if (settings.layout === 'wide') {
                document.getElementById('mainContainer').classList.remove('centered');
            } else {
                document.getElementById('mainContainer').classList.add('centered');
            }

            if (settings.autoRefresh) {
                startAutoRefresh();
            }

            // For symbols, if nerdfonts, add class or load font (assuming loaded)
            if (settings.useSymbols === 'nerdfonts') {
                // Example: document.body.classList.add('nerd-fonts');
                // Requires Nerd Fonts CSS/font loaded
            }
        }

        function saveSettings() {
            settings.theme = document.getElementById('themeSelect').value;
            settings.layout = document.getElementById('layoutSelect').value;
            settings.useSymbols = document.getElementById('symbolSelect').value;
            settings.showUsernames = document.getElementById('showUsernames').checked;
            settings.enableImageHover = document.getElementById('enableImageHover').checked;
            settings.enableReplyHover = document.getElementById('enableReplyHover').checked;
            settings.enableTreeView = document.getElementById('enableTreeView').checked;
            settings.autoRefresh = document.getElementById('autoRefresh').checked;
            settings.refreshInterval = parseInt(document.getElementById('refreshInterval').value);
            settings.sidebarAutoHide = document.getElementById('sidebarAutoHide').checked;

            if (settings.theme === 'custom') {
                settings.customColors = {
                    bgPrimary: document.getElementById('colorBgPrimary').value,
                    textPrimary: document.getElementById('colorTextPrimary').value,
                    // Add more
                };
            }

            fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings)
            }).then(() => {
                applySettings();
                showNotification('Settings saved');
            });
        }

        function changeTheme() {
            const value = document.getElementById('themeSelect').value;
            document.body.setAttribute('data-theme', value);
            document.getElementById('customColorsGroup').style.display = value === 'custom' ? 'block' : 'none';
        }

        function changeLayout() {
            const layout = document.getElementById('layoutSelect').value;
            if (layout === 'wide') {
                document.getElementById('mainContainer').classList.remove('centered');
            } else {
                document.getElementById('mainContainer').classList.add('centered');
            }
        }

        function changeSymbols() {
            // Implement symbol changes if needed, e.g., replace icons dynamically
            saveSettings();
        }

        function toggleAutoRefresh() {
            if (document.getElementById('autoRefresh').checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }

        function startAutoRefresh() {
            stopAutoRefresh();
            const interval = (settings.refreshInterval || 60) * 1000;
            autoRefreshInterval = setInterval(() => {
                if (currentThread && currentBoard) {
                    loadThread(currentBoard, currentThread, true);
                }
            }, interval);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        function setupSidebarAutoHide() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');

            document.addEventListener('mousemove', (e) => {
                if (!settings.sidebarAutoHide) return;

                clearTimeout(sidebarTimeout);

                if (e.clientX < 280) {
                    sidebar.classList.remove('hidden');
                    mainContent.classList.remove('expanded');
                } else {
                    sidebarTimeout = setTimeout(() => {
                        if (e.clientX > 280) {
                            sidebar.classList.add('hidden');
                            mainContent.classList.add('expanded');
                        }
                    }, 2000);
                }
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('hidden');
            mainContent.classList.toggle('expanded');
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function showNotification(message) {
            // Simple notification, can be improved
            alert(message);
        }

        function showError(message) {
            // Show error in UI
            alert(message);
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function stripHtml(html) {
            let tmp = document.createElement("DIV");
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || "";
        }

        async function loadBoards() {
            try {
                const response = await fetch('/api/boards');
                const boards = await response.json();
                
                const boardsList = document.getElementById('boardsList');
                const quickBoards = document.getElementById('quickBoards');
                boardsList.innerHTML = '';
                quickBoards.innerHTML = '';
                
                boards.forEach(board => {
                    const card = document.createElement('div');
                    card.className = 'board-card';
                    card.onclick = () => loadCatalog(board.board, board.title);
                    card.innerHTML = `
                        <div class="board-name">/${board.board}/</div>
                        <div>${escapeHtml(board.title)}</div>
                    `;
                    boardsList.appendChild(card);

                    if (['g', 'pol', 'v', 'a', 'b', 'biz'].includes(board.board)) {
                        const quickItem = document.createElement('div');
                        quickItem.className = 'board-item';
                        quickItem.onclick = () => loadCatalog(board.board, board.title);
                        quickItem.textContent = `/${board.board}/ - ${board.title}`;
                        quickBoards.appendChild(quickItem);
                    }
                });
                
                document.querySelector('#boardsView .loading').style.display = 'none';
            } catch (error) {
                showError('Failed to load boards');
            }
        }

        async function loadCatalog(board, title) {
            currentBoard = board;
            viewStack.push('boards');
            
            showView('threadsView');
            document.getElementById('boardTitle').textContent = `/${board}/ - ${title}`;
            
            try {
                const response = await fetch(`/api/catalog/${board}`);
                const threads = await response.json();
                
                window.currentCatalog = {board, threads: threads.map(t => t.no)};
                
                const threadsList = document.getElementById('threadsList');
                threadsList.innerHTML = '';
                
                threads.forEach(thread => {
                    const item = document.createElement('div');
                    item.className = 'thread-item';
                    item.onclick = () => loadThread(board, thread.no);
                    
                    const sub = thread.sub ? escapeHtml(thread.sub) : 'No Subject';
                    const com = thread.com ? stripHtml(thread.com).substring(0, 200) : '';
                    
                    let thumbHtml = '<div class="placeholder"><i class="fas fa-image"></i></div>';
                    if (thread.tim && thread.ext) {
                        thumbHtml = `<img src="/thumbs/${board}/${thread.tim}s.jpg" alt="Thumbnail" onerror="this.parentElement.innerHTML='<div class=\\'placeholder\\'><i class=\\'fas fa-image\\'></i></div>'">`;
                    }
                    
                    item.innerHTML = `
                        <div class="thread-thumb">${thumbHtml}</div>
                        <div class="thread-details">
                            <div class="thread-info">
                                <span><i class="fas fa-hashtag"></i> ${thread.no}</span>
                                <span><i class="fas fa-comments"></i> ${thread.replies || 0}</span>
                                <span><i class="fas fa-images"></i> ${thread.images || 0}</span>
                            </div>
                            <strong>${sub}</strong>
                            <div style="color: var(--text-secondary); margin-top: 5px;">${com}...</div>
                        </div>
                    `;
                    threadsList.appendChild(item);
                });
                
                document.querySelector('#threadsView .loading').style.display = 'none';
            } catch (error) {
                showError('Failed to load catalog');
            }
        }

        async function loadThread(board, threadId, skipHistory = false) {
            if (currentBoard && currentThread) {
                threadPositions[`${currentBoard}/${currentThread}`] = window.scrollY;
                localStorage.setItem('threadPositions', JSON.stringify(threadPositions));
            }

            const scrollPos = window.scrollY;
            currentThread = threadId;
            
            if (!skipHistory) {
                viewStack.push('threads');
            }
            
            showView('threadView');
            document.getElementById('threadTitle').textContent = `Thread #${threadId}`;
            
            try {
                const response = await fetch(`/api/thread/${board}/${threadId}`);
                const data = await response.json();
                const posts = data.posts || [];
                
                postsData = {};
                const postReplies = {};
                
                posts.forEach(post => {
                    postsData[post.no] = post;
                    postReplies[post.no] = [];
                });

                posts.forEach(post => {
                    const com = post.com || '';
                    const matches = com.matchAll(/&gt;&gt;(\d+)/g);
                    for (const match of matches) {
                        const replyTo = match[1];
                        if (postReplies[replyTo]) {
                            postReplies[replyTo].push(post.no);
                        }
                    }
                });
                
                const postsList = document.getElementById('postsList');
                postsList.innerHTML = '';
                
                if (settings.enableTreeView) {
                    const postMap = new Map();
                    posts.forEach(p => postMap.set(p.no, p));
                    const children = new Map();
                    posts.forEach(p => children.set(p.no, []));

                    posts.slice(1).forEach(post => {
                        let parent = posts[0].no;
                        if (post.com) {
                            const matches = [...post.com.matchAll(/&gt;&gt;(\d+)/g)];
                            if (matches.length) {
                                parent = parseInt(matches[matches.length - 1][1]);
                            }
                        }
                        if (postMap.has(parent)) {
                            children.get(parent).push(post.no);
                        } else {
                            children.get(posts[0].no).push(post.no);
                        }
                    });

                    function renderPost(no, depth = 0) {
                        const post = postMap.get(no);
                        const div = createPostElement(post, board, no === posts[0].no, children.get(no).length);
                        div.style.marginLeft = `${depth * 20}px`;
                        children.get(no).forEach(child => {
                            div.appendChild(renderPost(child, depth + 1));
                        });
                        return div;
                    }

                    postsList.appendChild(renderPost(posts[0].no));
                } else {
                    posts.forEach((post, index) => {
                        const postDiv = createPostElement(post, board, index === 0, postReplies[post.no] || []);
                        postsList.appendChild(postDiv);
                    });
                }
                
                attachEventListeners();
                
                setTimeout(() => {
                    const key = `${board}/${threadId}`;
                    const pos = skipHistory ? scrollPos : (threadPositions[key] || 0);
                    window.scrollTo(0, pos);
                }, 0);

                await updateNavButtons(board, threadId);
                
                document.querySelector('#threadView .loading').style.display = 'none';
            } catch (error) {
                showError('Failed to load thread');
            }
        }

        async function updateNavButtons(board, threadId) {
            if (!currentCatalog || currentCatalog.board !== board) {
                const res = await fetch(`/api/catalog/${board}`);
                const threads = await res.json();
                currentCatalog = {board, threads: threads.map(t => t.no)};
            }

            const index = currentCatalog.threads.indexOf(threadId);
            const prevBtn = document.getElementById('prevThreadBtn');
            const nextBtn = document.getElementById('nextThreadBtn');

            prevBtn.style.display = index > 0 ? '' : 'none';
            nextBtn.style.display = index < currentCatalog.threads.length - 1 ? '' : 'none';

            if (index > 0) {
                prevBtn.onclick = () => loadThread(board, currentCatalog.threads[index - 1]);
            }
            if (index < currentCatalog.threads.length - 1) {
                nextBtn.onclick = () => loadThread(board, currentCatalog.threads[index + 1]);
            }
        }

        function createPostElement(post, board, isOP, replyCount) {
            const postDiv = document.createElement('div');
            postDiv.className = 'post' + (isOP ? ' op-post' : '');
            postDiv.id = `post-${post.no}`;
            
            const date = new Date(post.time * 1000).toLocaleString();
            const username = settings.showUsernames ? escapeHtml(post.name || 'Anonymous') : 'Anonymous';
            
            let imageHtml = '';
            if (post.tim && post.ext) {
                const imgSrc = `/images/${board}/${post.tim}${post.ext}`;
                const thumbSrc = `/thumbs/${board}/${post.tim}s.jpg`;
                imageHtml = `
                    <div class="post-image">
                        <img src="${thumbSrc}" alt="${escapeHtml(post.filename || '')}" data-full="${imgSrc}">
                    </div>
                `;
            }
            
            let comHtml = (post.com || '').replace(/&gt;(.*?$)/gm, '<span class="greentext">&gt;$1</span>')
                .replace(/&gt;&gt;(\d+)/g, '<a class="post-link quote-link" data-post="$1">&gt;&gt;$1</a>');
            
            postDiv.innerHTML = `
                <div class="post-header">
                    <span>${username} - ${date}</span>
                    <span>No. ${post.no} (${replyCount} replies)</span>
                </div>
                ${imageHtml}
                <div class="post-content">${comHtml}</div>
            `;
            
            return postDiv;
        }

        function attachEventListeners() {
            document.querySelectorAll('.post-link').forEach(link => {
                if (!settings.enableReplyHover) return;
                link.addEventListener('mouseover', showReplyPreview);
                link.addEventListener('mouseout', hidePreview);
            });

            document.querySelectorAll('.post-image img').forEach(img => {
                if (!settings.enableImageHover) return;
                img.addEventListener('mouseover', showImagePreview);
                img.addEventListener('mouseout', hidePreview);
                img.addEventListener('mousemove', movePreview);
            });
        }

        function showReplyPreview(e) {
            const postId = e.target.dataset.post;
            const post = postsData[postId];
            if (!post) return;

            const content = `
                <div class="post-header">
                    <span>${escapeHtml(post.name || 'Anonymous')} - ${new Date(post.time * 1000).toLocaleString()}</span>
                    <span>No. ${post.no}</span>
                </div>
                <div>${post.com || ''}</div>
            `;

            showPreview(e, content);
        }

        function showImagePreview(e) {
            const fullSrc = e.target.dataset.full;
            if (!fullSrc) return;

            const content = `<img src="${fullSrc}" alt="Preview">`;
            showPreview(e, content, 'image-preview');
        }

        function showPreview(e, content, className = 'hover-preview') {
            let preview = document.getElementById('preview');
            if (!preview) {
                preview = document.createElement('div');
                preview.id = 'preview';
                document.body.appendChild(preview);
            }
            preview.className = className;
            preview.innerHTML = content;
            preview.style.display = 'block';
            movePreview(e);
        }

        function movePreview(e) {
            const preview = document.getElementById('preview');
            if (!preview) return;

            preview.style.left = `${e.pageX + 10}px`;
            preview.style.top = `${e.pageY + 10}px`;
        }

        function hidePreview() {
            const preview = document.getElementById('preview');
            if (preview) {
                preview.style.display = 'none';
            }
        }

        function loadHistory() {
            fetch('/api/history')
                .then(r => r.json())
                .then(history => {
                    const historyList = document.getElementById('historyList');
                    historyList.innerHTML = '';
                    history.reverse().forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        div.onclick = () => loadThread(item.board, item.thread_id);
                        div.innerHTML = `
                            <span class="board-tag">/${item.board}/ -> ${escapeHtml(item.title)} (#${item.thread_id})</span>
                            <span style="color: var(--text-secondary); font-size: 12px;">${new Date(item.timestamp * 1000).toLocaleString()}</span>
                        `;
                        historyList.appendChild(div);
                    });
                });
        }

        function clearHistory() {
            fetch('/api/history/clear', {method: 'POST'}).then(() => loadHistory());
        }

        function filterHistory() {
            const query = document.getElementById('historySearch').value.toLowerCase();
            Array.from(document.getElementById('historyList').children).forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? '' : 'none';
            });
        }

        function filterThreads() {
            const query = document.getElementById('threadSearch').value.toLowerCase();
            Array.from(document.getElementById('threadsList').children).forEach(item => {
                const title = item.querySelector('strong').textContent.toLowerCase();
                const com = item.querySelector('div[style*="margin-top"]').textContent.toLowerCase();
                item.style.display = (title.includes(query) || com.includes(query)) ? '' : 'none';
            });
        }

        function showView(viewId) {
            document.getElementById('boardsView').classList.add('hidden');
            document.getElementById('threadsView').classList.add('hidden');
            document.getElementById('threadView').classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
            document.getElementById('backBtn').classList.toggle('hidden', viewStack.length === 0);
        }

        function goBack() {
            const prevView = viewStack.pop();
            if (prevView === 'boards') {
                showView('boardsView');
            } else if (prevView === 'threads') {
                showView('threadsView');
            }
        }

        function refreshCache() {
            fetch('/api/refresh').then(() => {
                location.reload();
            });
        }
    </script>
</body>
</html>
